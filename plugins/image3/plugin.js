/*
 Copyright (c) 2003-2017, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
 This plugin is a direct copy of Image2 with added logic to handle sizing images by percentages.
*/
(function(){function E(a){function b(){this.deflated||(a.widgets.focused==this.widget&&(this.focused=!0),a.widgets.destroy(this.widget),this.deflated=!0)}function g(){var d=a.editable(),c=a.document;if(this.deflated)this.widget=a.widgets.initOn(this.element,"image",this.widget.data),this.widget.inline&&!(new CKEDITOR.dom.elementPath(this.widget.wrapper,d)).block&&(d=c.createElement(a.activeEnterMode==CKEDITOR.ENTER_P?"p":"div"),d.replace(this.widget.wrapper),this.widget.wrapper.move(d)),this.focused&&
(this.widget.focus(),delete this.focused),delete this.deflated;else{var b=this.widget,d=f,c=b.wrapper,e=b.data.align,b=b.data.hasCaption;if(d){for(var q=3;q--;)c.removeClass(d[q]);"center"==e?b&&c.addClass(d[1]):"none"!=e&&c.addClass(d[x[e]])}else"center"==e?(b?c.setStyle("text-align","center"):c.removeStyle("text-align"),c.removeStyle("float")):("none"==e?c.removeStyle("float"):c.setStyle("float",e),c.removeStyle("text-align"))}}var f=a.config.image3_alignClasses,e=a.config.image3_captionedClass;
return{allowedContent:F(a),requiredContent:"img[src,alt]",features:G(a),styleableElements:"img figure",contentTransformations:[],editables:{caption:{selector:"figcaption",allowedContent:"br em strong sub sup u s; a[!href,target]"}},parts:{image:"img",caption:"figcaption"},dialog:"image3",template:'\x3cimg alt\x3d"" src\x3d"" /\x3e',data:function(){var d=this.features;this.data.hasCaption&&!a.filter.checkFeature(d.caption)&&(this.data.hasCaption=!1);"none"==this.data.align||a.filter.checkFeature(d.align)||
(this.data.align="none");this.shiftState({widget:this,element:this.element,oldData:this.oldData,newData:this.data,deflate:b,inflate:g});this.data.link?this.parts.link||(this.parts.link=this.parts.image.getParent()):this.parts.link&&delete this.parts.link;this.parts.image.setAttributes({src:this.data.src,"data-cke-saved-src":this.data.src,alt:this.data.alt});if(this.oldData&&!this.oldData.hasCaption&&this.data.hasCaption)for(var c in this.data.classes)this.parts.image.removeClass(c);if(a.filter.checkFeature(d.dimension)){d=
this.data;c={width:d.width,height:d.height};var f=this.parts.image,e=this.wrapper,q=this.resizeWrapper,p=this.element;"center"==this.data.align&&q&&(e=q);if(d.sizeImageBy==CKEDITOR.plugins.image3.PERCENT)for(var h in c){var q=parseInt(f.getStyle("border-width"))||0,m;if("width"==h){m=parseInt(f.getStyle("margin-left"))||0;var n=parseInt(f.getStyle("margin-right"))||0;m=2*q+m+n;f.setStyle("width","calc(100% - "+m+"px)")}else"height"==h&&(m=parseInt(f.getStyle("margin-top"))||0,n=parseInt(f.getStyle("margin-bottom"))||
0,m=2*q+m+n,f.setStyle("height","calc(100% - "+m+"px)"));d.hasCaption&&p&&p.setStyle(h,"100%");e&&(c[h]?e.setStyle(h,"calc("+c[h]+d.sizeImageBy+" + "+m+"px)"):e.removeStyle(h))}else for(h in c)e&&e.removeStyle(h),q&&q.removeStyle(h),d.hasCaption&&p&&p.removeStyle(h),c[h]?f.setAttribute(h,c[h]+d.sizeImageBy):f.removeAttribute(h),f.removeStyle(h)}this.oldData=CKEDITOR.tools.extend({},this.data)},init:function(){var d=CKEDITOR.plugins.image3,c=this.parts.image,b={hasCaption:!!this.parts.caption,src:c.getAttribute("src"),
alt:c.getAttribute("alt")||"",width:c.getAttribute("width")||"",height:c.getAttribute("height")||"",lock:this.ready?d.checkHasNaturalRatio(c):!0};-1==b.width.indexOf(d.PERCENT)&&-1==b.height.indexOf(d.PERCENT)?b.sizeImageBy="px":b.sizeImageBy=d.PERCENT;b.width=parseInt(b.width);b.height=parseInt(b.height);var e=c.getAscendant("a");e&&this.wrapper.contains(e)&&(this.parts.link=e);b.align||(c=b.hasCaption?this.element:c,f?(c.hasClass(f[0])?b.align="left":c.hasClass(f[2])&&(b.align="right"),b.align?
c.removeClass(f[x[b.align]]):b.align="none"):(b.align=c.getStyle("float")||"none",c.removeStyle("float")));a.plugins.link&&this.parts.link&&(b.link=d.getLinkAttributesParser()(a,this.parts.link),(c=b.link.advanced)&&c.advCSSClasses&&(c.advCSSClasses=CKEDITOR.tools.trim(c.advCSSClasses.replace(/cke_\S+/,""))));this.wrapper[(b.hasCaption?"remove":"add")+"Class"]("cke_image_nocaption");this.setData(b);a.filter.checkFeature(this.features.dimension)&&!0!==a.config.image3_disableResizer&&1!=a.readOnly&&
H(this);this.shiftState=d.stateShifter(this.editor);this.on("contextMenu",function(a){a.data.image=CKEDITOR.TRISTATE_OFF;if(this.parts.link||this.wrapper.getAscendant("a"))a.data.link=a.data.unlink=CKEDITOR.TRISTATE_OFF});this.on("dialog",function(a){a.data.widget=this},this)},addClass:function(a){u(this).addClass(a)},hasClass:function(a){return u(this).hasClass(a)},removeClass:function(a){u(this).removeClass(a)},getClasses:function(){var a=new RegExp("^("+[].concat(e,f).join("|")+")$");return function(){var b=
this.repository.parseElementClasses(u(this).getAttribute("class")),f;for(f in b)a.test(f)&&delete b[f];return b}}(),upcast:I(a),downcast:J(a),getLabel:function(){return this.editor.lang.widget.label.replace(/%1/,(this.data.alt||"")+" "+this.pathName)}}}function I(a){var b=v(a),g=a.config.image3_captionedClass;return function(a,e){var d=a.name,c;if(!a.attributes["data-cke-realelement"]&&(b(a)?("div"==d&&(d=a.getFirst("figure"))&&(a.replaceWith(d),a=d),e.align="center",c=a.getFirst("img")||a.getFirst("a").getFirst("img")):
"figure"==d&&a.hasClass(g)?c=a.getFirst("img")||a.getFirst("a").getFirst("img"):y(a)&&(c="a"==a.name?a.children[0]:a),c))return a}}function J(a){var b=a.config.image3_alignClasses;return function(g){var f="a"==g.name?g.getFirst():g,e=f.attributes,d=this.data.align;if(!this.inline){var c=g.getFirst("span");c&&c.replaceWith(c.getFirst({img:1,a:1}))}d&&"none"!=d&&(c=CKEDITOR.tools.parseCssText(e.style||""),"center"==d&&"figure"==g.name?g=g.wrapWith(new CKEDITOR.htmlParser.element("div",b?{"class":b[1]}:
{style:"text-align:center"})):d in{left:1,right:1}&&(b?f.addClass(b[x[d]]):c["float"]=d),b||CKEDITOR.tools.isEmpty(c)||(e.style=CKEDITOR.tools.writeCssText(c)));f=CKEDITOR.plugins.image3;if(a.filter.checkFeature(this.features.dimension)&&(c=this.data,c.sizeImageBy==f.PERCENT)){f="img"==g.name?g:g.find("img")[0];c.width&&(f.attributes.width=c.width+c.sizeImageBy);c.height&&(f.attributes.height=c.height+c.sizeImageBy);c=f.attributes.style.split(";");e="";for(d=0;d<c.length;d++){var k=c[d].split(":")[0].trim();
"width"!=k&&"height"!=k&&(e+=c[d]+";")}f.attributes.style=e}return g}}function v(a){var b=a.config.image3_captionedClass,g=a.config.image3_alignClasses,f={figure:1,a:1,img:1};return function(e){if(!(e.name in{div:1,p:1}))return!1;var d=e.children;if(1!==d.length)return!1;d=d[0];if(!(d.name in f))return!1;if("p"==e.name){if(!y(d))return!1}else if("figure"==d.name){if(!d.hasClass(b))return!1}else if(a.enterMode==CKEDITOR.ENTER_P||!y(d))return!1;return(g?e.hasClass(g[1]):"center"==CKEDITOR.tools.parseCssText(e.attributes.style||
"",!0)["text-align"])?!0:!1}}function y(a){return"img"==a.name?!0:"a"==a.name?1==a.children.length&&a.getFirst("img"):!1}function H(a){var b=a.editor,g=b.editable(),f=b.document,e=a.resizer=f.createElement("span");e.addClass("cke_image_resizer");e.setAttribute("title",b.lang.image3.resizer);e.append(new CKEDITOR.dom.text("​",f));if(a.inline)a.wrapper.append(e);else{var d=a.parts.link||a.parts.image,c=d.getParent(),k=f.createElement("span");k.addClass("cke_image_resizer_wrapper");k.append(d);k.append(e);
a.element.append(k,!0);a.resizeWrapper=k;c.is("span")&&c.remove()}e.on("mousedown",function(c){function d(a,b,c){var e=CKEDITOR.document,h=[];f.equals(e)||h.push(e.on(a,b));h.push(f.on(a,b));if(c)for(a=h.length;a--;)c.push(h.pop())}function p(){r=u+k*A;t=Math.round(r/z)}function h(){t=x-w;r=Math.round(t*z)}var m=CKEDITOR.plugins.image3,n=a.parts.image,k="right"==a.data.align?-1:1,K=c.data.$.screenX,l=c.data.$.screenY,u=n.$.clientWidth,x=n.$.clientHeight,z=u/x,v=[],y="cke_image_s"+(~k?"e":"w"),C,r,
t,D,A,w,B;b.fire("saveSnapshot");d("mousemove",function(b){C=b.data.$;A=C.screenX-K;w=l-C.screenY;B=Math.abs(A/w);1==k?0>=A?0>=w?p():B>=z?p():h():0>=w?B>=z?h():p():h():0>=A?0>=w?B>=z?h():p():h():0>=w?p():B>=z?p():h();D=!0;15<=r&&15<=t&&(n.setAttributes({width:r,height:t}),n.removeStyle("width"),n.removeStyle("height"),a.resizeWrapper&&(a.resizeWrapper.removeStyle("width"),a.resizeWrapper.removeStyle("height")),a.wrapper&&(a.wrapper.removeStyle("width"),a.wrapper.removeStyle("height")))},v);d("mouseup",
function(){for(var c;c=v.pop();)c.removeListener();g.removeClass(y);e.removeClass("cke_image_resizing");a.data.sizeImageBy==m.PERCENT?(c={width:n.getAttribute("width"),height:n.getAttribute("height")},c=m.convertDimensionsTo(a,c,m.PERCENT,m.getNatural),r=c.width,t=c.height):(r=parseInt(n.getAttribute("width"),10),t=parseInt(n.getAttribute("height"),10));D&&r&&t&&a.setData({width:r,height:t});b.fire("saveSnapshot");D=!1},v);g.addClass(y);e.addClass("cke_image_resizing")});a.on("data",function(){e["right"==
a.data.align?"addClass":"removeClass"]("cke_image_resizer_left")})}function L(a){var b=[],g;return function(f){var e=a.getCommand("justify"+f);if(e){b.push(function(){e.refresh(a,a.elementPath())});if(f in{right:1,left:1,center:1})e.on("exec",function(d){var c=l(a);if(c){c.setData("align",f);for(c=b.length;c--;)b[c]();d.cancel()}});e.on("refresh",function(b){var c=l(a),e={right:1,left:1,center:1};c&&(void 0===g&&(g=a.filter.checkFeature(a.widgets.registered.image.features.align)),g?this.setState(c.data.align==
f?CKEDITOR.TRISTATE_ON:f in e?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED):this.setState(CKEDITOR.TRISTATE_DISABLED),b.cancel())})}}}function M(a){a.plugins.link&&(CKEDITOR.on("dialogDefinition",function(b){b=b.data;if("link"==b.name){b=b.definition;var g=b.onShow,f=b.onOk;b.onShow=function(){var b=l(a),d=this.getContentElement("info","linkDisplayText").getElement().getParent().getParent();b&&(b.inline?!b.wrapper.getAscendant("a"):1)?(this.setupContent(b.data.link||{}),d.hide()):(d.show(),g.apply(this,
arguments))};b.onOk=function(){var b=l(a);if(b&&(b.inline?!b.wrapper.getAscendant("a"):1)){var d={};this.commitContent(d);b.setData("link",d)}else f.apply(this,arguments)}}}),a.getCommand("unlink").on("exec",function(b){var g=l(a);g&&g.parts.link&&(g.setData("link",null),this.refresh(a,a.elementPath()),b.cancel())}),a.getCommand("unlink").on("refresh",function(b){var g=l(a);g&&(this.setState(g.data.link||g.wrapper.getAscendant("a")?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),b.cancel())}))}
function l(a){return(a=a.widgets.focused)&&"image"==a.name?a:null}function F(a){var b=a.config.image3_alignClasses;a={div:{match:v(a)},p:{match:v(a)},img:{attributes:"!src,alt,width,height",styles:"border-style,border-width,float,height,margin,margin-bottom,margin-left,margin-right,margin-top,width"},figure:{classes:"!"+a.config.image3_captionedClass},figcaption:!0};b?(a.div.classes=b[1],a.p.classes=a.div.classes,a.img.classes=b[0]+","+b[2],a.figure.classes+=","+a.img.classes):(a.div.styles="text-align",
a.p.styles="text-align",a.figure.styles="float,display");return a}function G(a){a=a.config.image3_alignClasses;return{dimension:{requiredContent:"img[width,height]"},align:{requiredContent:"img"+(a?"("+a[0]+")":"{float}")},caption:{requiredContent:"figcaption"}}}function u(a){return a.data.hasCaption?a.element:a.parts.image}var N=new CKEDITOR.template('\x3cfigure class\x3d"{captionedClass}"\x3e\x3cimg alt\x3d"" src\x3d"" /\x3e\x3cfigcaption\x3e{captionPlaceholder}\x3c/figcaption\x3e\x3c/figure\x3e'),
x={left:0,center:1,right:2};CKEDITOR.plugins.add("image3",{lang:"af,ar,az,bg,bn,bs,ca,cs,cy,da,de,de-ch,el,en,en-au,en-ca,en-gb,eo,es,es-mx,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,oc,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",requires:"widget,dialog",icons:"image",hidpi:!0,onLoad:function(){CKEDITOR.addCss(".cke_image_nocaption{line-height:0}.cke_editable.cke_image_sw, .cke_editable.cke_image_sw *{cursor:sw-resize !important}.cke_editable.cke_image_se, .cke_editable.cke_image_se *{cursor:se-resize !important}.cke_image_resizer{display:none;position:absolute;width:10px;height:10px;bottom:-5px;right:-5px;background:#000;outline:1px solid #fff;line-height:0;cursor:se-resize;}.cke_image_resizer_wrapper{position:relative;display:inline-block;line-height:0;}.cke_image_resizer.cke_image_resizer_left{right:auto;left:-5px;cursor:sw-resize;}.cke_widget_wrapper:hover .cke_image_resizer,.cke_image_resizer.cke_image_resizing{display:block}.cke_widget_wrapper\x3ea{display:inline-block}")},
init:function(a){var b=a.config,g=a.lang.image3,f=E(a);b.filebrowserImage3BrowseUrl=b.filebrowserImageBrowseUrl;b.filebrowserImage3UploadUrl=b.filebrowserImageUploadUrl;f.pathName=g.pathName;f.editables.caption.pathName=g.pathNameCaption;a.widgets.add("image",f);a.ui.addButton&&a.ui.addButton("Image",{label:a.lang.common.resize,command:"image",toolbar:"insert,10"});a.contextMenu&&(a.addMenuGroup("image",10),a.addMenuItem("image",{label:g.menu,command:"image",group:"image"}));CKEDITOR.dialog.add("image3",
this.path+"dialogs/image3.js")},afterInit:function(a){var b={left:1,right:1,center:1,block:1},g=L(a),f;for(f in b)g(f);M(a)}});CKEDITOR.plugins.image3={PERCENT:"%",PIXEL:"px",stateShifter:function(a){function b(a,b){var c={};e?c.attributes={"class":e[1]}:c.styles={"text-align":"center"};c=f.createElement(a.activeEnterMode==CKEDITOR.ENTER_P?"p":"div",c);g(c,b);b.move(c);return c}function g(b,d){if(d.getParent()){var e=a.createRange();e.moveToPosition(d,CKEDITOR.POSITION_BEFORE_START);d.remove();c.insertElementIntoRange(b,
e)}else b.replace(d)}var f=a.document,e=a.config.image3_alignClasses,d=a.config.image3_captionedClass,c=a.editable(),k=["hasCaption","align","link"],l={align:function(c,d,f){var g=c.element;c.changed.align?c.newData.hasCaption||("center"==f&&(c.deflate(),c.element=b(a,g)),c.changed.hasCaption||"center"!=d||"center"==f||(c.deflate(),d=g.findOne("a,img"),d.replace(g),c.element=d)):"center"==f&&c.changed.hasCaption&&!c.newData.hasCaption&&(c.deflate(),c.element=b(a,g));!e&&g.is("figure")&&("center"==
f?g.setStyle("display","inline-block"):g.removeStyle("display"))},hasCaption:function(b,c,e){b.changed.hasCaption&&(c=b.element.is({img:1,a:1})?b.element:b.element.findOne("a,img"),b.deflate(),e?(e=CKEDITOR.dom.element.createFromHtml(N.output({captionedClass:d,captionPlaceholder:a.lang.image3.captionPlaceholder}),f),g(e,b.element),c.replace(e.findOne("img")),b.element=e):(c.replace(b.element),b.element=c))},link:function(b,c,d){if(b.changed.link){var e=b.element.is("img")?b.element:b.element.findOne("img"),
g=b.element.is("a")?b.element:b.element.findOne("a"),k=b.element.is("a")&&!d||b.element.is("img")&&d,l;k&&b.deflate();d?(c||(l=f.createElement("a",{attributes:{href:b.newData.link.url}}),l.replace(e),e.move(l)),d=CKEDITOR.plugins.image3.getLinkAttributesGetter()(a,d),CKEDITOR.tools.isEmpty(d.set)||(l||g).setAttributes(d.set),d.removed.length&&(l||g).removeAttributes(d.removed)):(d=g.findOne("img"),d.replace(g),l=d);k&&(b.element=l)}}};return function(a){var b,c;a.changed={};for(c=0;c<k.length;c++)b=
k[c],a.changed[b]=a.oldData?a.oldData[b]!==a.newData[b]:!1;for(c=0;c<k.length;c++)b=k[c],l[b](a,a.oldData?a.oldData[b]:null,a.newData[b]);a.inflate()}},checkHasNaturalRatio:function(a){var b=a.$;a=this.getNatural(a);return Math.round(b.clientWidth/a.width*a.height)==b.clientHeight||Math.round(b.clientHeight/a.height*a.width)==b.clientWidth},getNatural:function(a){if(a.$.naturalWidth)a={width:a.$.naturalWidth,height:a.$.naturalHeight};else{var b=new Image;b.src=a.getAttribute("src");a={width:b.width,
height:b.height}}return a},convertDimensionsTo:function(a,b,g,f){var e=a.wrapper.getParent().getClientRect(),d=e.width,e=e.height;void 0==typeof f&&(f=this.getNatural(a.parts.image));a={width:0,height:0};g==this.PIXEL?(a.width=Math.round(b.width/100*d),a.height=Math.round((f.height||1)/(f.width||1)*a.width)):g==this.PERCENT&&(0==d&&(d=1),0==e&&(e=1),a.height=Math.round(b.height/e*100),a.width=Math.round(b.width/d*100));return a},getLinkAttributesGetter:function(){return CKEDITOR.plugins.link.getLinkAttributes},
getLinkAttributesParser:function(){return CKEDITOR.plugins.link.parseLinkAttributes}}})();CKEDITOR.config.image3_captionedClass="image";