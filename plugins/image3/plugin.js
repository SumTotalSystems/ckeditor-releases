/*
 Copyright (c) 2003-2017, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
 This plugin is a direct copy of Image2 with added logic to handle sizing images by percentages.
*/
(function(){function E(a){function b(){this.deflated||(a.widgets.focused==this.widget&&(this.focused=!0),a.widgets.destroy(this.widget),this.deflated=!0)}function f(){var c=a.editable(),g=a.document;if(this.deflated)this.widget=a.widgets.initOn(this.element,"image",this.widget.data),this.widget.inline&&!(new CKEDITOR.dom.elementPath(this.widget.wrapper,c)).block&&(c=g.createElement(a.activeEnterMode==CKEDITOR.ENTER_P?"p":"div"),c.replace(this.widget.wrapper),this.widget.wrapper.move(c)),this.focused&&
(this.widget.focus(),delete this.focused),delete this.deflated;else{var b=this.widget,c=e,g=b.wrapper,d=b.data.align,b=b.data.hasCaption;if(c){for(var n=3;n--;)g.removeClass(c[n]);"center"==d?b&&g.addClass(c[1]):"none"!=d&&g.addClass(c[w[d]])}else"center"==d?(b?g.setStyle("text-align","center"):g.removeStyle("text-align"),g.removeStyle("float")):("none"==d?g.removeStyle("float"):g.setStyle("float",d),g.removeStyle("text-align"))}}var e=a.config.image3_alignClasses,d=a.config.image3_captionedClass;
return{allowedContent:F(a),requiredContent:"img[src,alt]",features:G(a),styleableElements:"img figure",contentTransformations:[],editables:{caption:{selector:"figcaption",allowedContent:"br em strong sub sup u s; a[!href,target]"}},parts:{image:"img",caption:"figcaption"},dialog:"image3",template:'\x3cimg alt\x3d"" src\x3d"" /\x3e',data:function(){var c=this.features;this.data.hasCaption&&!a.filter.checkFeature(c.caption)&&(this.data.hasCaption=!1);"none"==this.data.align||a.filter.checkFeature(c.align)||
(this.data.align="none");this.shiftState({widget:this,element:this.element,oldData:this.oldData,newData:this.data,deflate:b,inflate:f});this.data.link?this.parts.link||(this.parts.link=this.parts.image.getParent()):this.parts.link&&delete this.parts.link;this.parts.image.setAttributes({src:this.data.src,"data-cke-saved-src":this.data.src,alt:this.data.alt});if(this.oldData&&!this.oldData.hasCaption&&this.data.hasCaption)for(var g in this.data.classes)this.parts.image.removeClass(g);if(a.filter.checkFeature(c.dimension)){c=
this.data;g={width:c.width,height:c.height};var e=this.parts.image,d=this.wrapper,n=this.resizeWrapper,B=this.element;"center"==this.data.align&&n&&(d=n);if(c.sizeImageBy==CKEDITOR.plugins.image3.PERCENT)for(var h in g){var n=parseInt(e.getStyle("border-width"))||0,m;if("width"==h){m=parseInt(e.getStyle("margin-left"))||0;var p=parseInt(e.getStyle("margin-right"))||0;m=2*n+m+p;e.setStyle("width","calc(100% - "+m+"px)")}else"height"==h&&(m=parseInt(e.getStyle("margin-top"))||0,p=parseInt(e.getStyle("margin-bottom"))||
0,m=2*n+m+p,e.setStyle("height","calc(100% - "+m+"px)"));c.hasCaption&&B&&B.setStyle(h,"100%");d&&(g[h]?d.setStyle(h,"calc("+g[h]+c.sizeImageBy+" + "+m+"px)"):d.removeStyle(h))}else for(h in g)d&&d.removeStyle(h),n&&n.removeStyle(h),c.hasCaption&&B&&B.removeStyle(h),g[h]?e.setAttribute(h,g[h]+c.sizeImageBy):e.removeAttribute(h),e.removeStyle(h)}this.oldData=CKEDITOR.tools.extend({},this.data)},init:function(){var c=CKEDITOR.plugins.image3,b=this.parts.image,d={hasCaption:!!this.parts.caption,src:b.getAttribute("src"),
alt:b.getAttribute("alt")||"",width:b.getAttribute("width")||"",height:b.getAttribute("height")||"",lock:this.ready?c.checkHasNaturalRatio(b):!0};-1==d.width.indexOf(c.PERCENT)&&-1==d.height.indexOf(c.PERCENT)?d.sizeImageBy="px":d.sizeImageBy=c.PERCENT;d.width=parseInt(d.width);d.height=parseInt(d.height);var f=b.getAscendant("a");f&&this.wrapper.contains(f)&&(this.parts.link=f);d.align||(b=d.hasCaption?this.element:b,e?(b.hasClass(e[0])?d.align="left":b.hasClass(e[2])&&(d.align="right"),d.align?
b.removeClass(e[w[d.align]]):d.align="none"):(d.align=b.getStyle("float")||"none",b.removeStyle("float")));a.plugins.link&&this.parts.link&&(d.link=c.getLinkAttributesParser()(a,this.parts.link),(b=d.link.advanced)&&b.advCSSClasses&&(b.advCSSClasses=CKEDITOR.tools.trim(b.advCSSClasses.replace(/cke_\S+/,""))));this.wrapper[(d.hasCaption?"remove":"add")+"Class"]("cke_image_nocaption");this.setData(d);a.filter.checkFeature(this.features.dimension)&&!0!==a.config.image3_disableResizer&&1!=a.readOnly&&
H(this);this.shiftState=c.stateShifter(this.editor);this.on("contextMenu",function(a){a.data.image=CKEDITOR.TRISTATE_OFF;if(this.parts.link||this.wrapper.getAscendant("a"))a.data.link=a.data.unlink=CKEDITOR.TRISTATE_OFF});this.on("dialog",function(a){a.data.widget=this},this)},addClass:function(a){t(this).addClass(a)},hasClass:function(a){return t(this).hasClass(a)},removeClass:function(a){t(this).removeClass(a)},getClasses:function(){var a=new RegExp("^("+[].concat(d,e).join("|")+")$");return function(){var b=
this.repository.parseElementClasses(t(this).getAttribute("class")),d;for(d in b)a.test(d)&&delete b[d];return b}}(),upcast:I(a),downcast:J(a),getLabel:function(){return this.editor.lang.widget.label.replace(/%1/,(this.data.alt||"")+" "+this.pathName)}}}function I(a){var b=u(a),f=a.config.image3_captionedClass;return function(a,d){var c=a.name,g;if(!a.attributes["data-cke-realelement"]&&(b(a)?("div"==c&&(c=a.getFirst("figure"))&&(a.replaceWith(c),a=c),d.align="center",g=a.getFirst("img")||a.getFirst("a").getFirst("img")):
"figure"==c&&a.hasClass(f)?g=a.getFirst("img")||a.getFirst("a").getFirst("img"):x(a)&&(g="a"==a.name?a.children[0]:a),g))return a}}function J(a){var b=a.config.image3_alignClasses;return function(f){var e="a"==f.name?f.getFirst():f,d=e.attributes,c=this.data.align;if(!this.inline){var g=f.getFirst("span");g&&g.replaceWith(g.getFirst({img:1,a:1}))}c&&"none"!=c&&(g=CKEDITOR.tools.parseCssText(d.style||""),"center"==c&&"figure"==f.name?f=f.wrapWith(new CKEDITOR.htmlParser.element("div",b?{"class":b[1]}:
{style:"text-align:center"})):c in{left:1,right:1}&&(b?e.addClass(b[w[c]]):g["float"]=c),b||CKEDITOR.tools.isEmpty(g)||(d.style=CKEDITOR.tools.writeCssText(g)));d=CKEDITOR.plugins.image3;a.filter.checkFeature(this.features.dimension)&&(e=this.data,e.sizeImageBy==d.PERCENT&&(d="img"==f.name?f:f.find("img")[0],e.width&&(d.attributes.width=e.width+e.sizeImageBy),e.height&&(d.attributes.height=e.height+e.sizeImageBy)));return f}}function u(a){var b=a.config.image3_captionedClass,f=a.config.image3_alignClasses,
e={figure:1,a:1,img:1};return function(d){if(!(d.name in{div:1,p:1}))return!1;var c=d.children;if(1!==c.length)return!1;c=c[0];if(!(c.name in e))return!1;if("p"==d.name){if(!x(c))return!1}else if("figure"==c.name){if(!c.hasClass(b))return!1}else if(a.enterMode==CKEDITOR.ENTER_P||!x(c))return!1;return(f?d.hasClass(f[1]):"center"==CKEDITOR.tools.parseCssText(d.attributes.style||"",!0)["text-align"])?!0:!1}}function x(a){return"img"==a.name?!0:"a"==a.name?1==a.children.length&&a.getFirst("img"):!1}function H(a){var b=
a.editor,f=b.editable(),e=b.document,d=a.resizer=e.createElement("span");d.addClass("cke_image_resizer");d.setAttribute("title",b.lang.image3.resizer);d.append(new CKEDITOR.dom.text("​",e));if(a.inline)a.wrapper.append(d);else{var c=a.parts.link||a.parts.image,g=c.getParent(),k=e.createElement("span");k.addClass("cke_image_resizer_wrapper");k.append(c);k.append(d);a.element.append(k,!0);a.resizeWrapper=k;g.is("span")&&g.remove()}d.on("mousedown",function(c){function n(a,b,d){var c=CKEDITOR.document,
h=[];e.equals(c)||h.push(c.on(a,b));h.push(e.on(a,b));if(d)for(a=h.length;a--;)d.push(h.pop())}function g(){q=t+k*z;r=Math.round(q/y)}function h(){r=w-v;q=Math.round(r*y)}var m=CKEDITOR.plugins.image3,p=a.parts.image,k="right"==a.data.align?-1:1,K=c.data.$.screenX,l=c.data.$.screenY,t=p.$.clientWidth,w=p.$.clientHeight,y=t/w,u=[],x="cke_image_s"+(~k?"e":"w"),C,q,r,D,z,v,A;b.fire("saveSnapshot");n("mousemove",function(b){C=b.data.$;z=C.screenX-K;v=l-C.screenY;A=Math.abs(z/v);1==k?0>=z?0>=v?g():A>=
y?g():h():0>=v?A>=y?h():g():h():0>=z?0>=v?A>=y?h():g():h():0>=v?g():A>=y?g():h();D=!0;15<=q&&15<=r&&(p.setAttributes({width:q,height:r}),p.removeStyle("width"),p.removeStyle("height"),a.resizeWrapper&&(a.resizeWrapper.removeStyle("width"),a.resizeWrapper.removeStyle("height")),a.wrapper&&(a.wrapper.removeStyle("width"),a.wrapper.removeStyle("height")))},u);n("mouseup",function(){for(var c;c=u.pop();)c.removeListener();f.removeClass(x);d.removeClass("cke_image_resizing");a.data.sizeImageBy==m.PERCENT?
(c={width:p.getAttribute("width"),height:p.getAttribute("height")},c=m.convertDimensionsTo(a,c,m.PERCENT,m.getNatural),q=c.width,r=c.height):(q=parseInt(p.getAttribute("width"),10),r=parseInt(p.getAttribute("height"),10));D&&q&&r&&a.setData({width:q,height:r});b.fire("saveSnapshot");D=!1},u);f.addClass(x);d.addClass("cke_image_resizing")});a.on("data",function(){d["right"==a.data.align?"addClass":"removeClass"]("cke_image_resizer_left")})}function L(a){var b=[],f;return function(e){var d=a.getCommand("justify"+
e);if(d){b.push(function(){d.refresh(a,a.elementPath())});if(e in{right:1,left:1,center:1})d.on("exec",function(d){var g=l(a);if(g){g.setData("align",e);for(g=b.length;g--;)b[g]();d.cancel()}});d.on("refresh",function(b){var d=l(a),k={right:1,left:1,center:1};d&&(void 0===f&&(f=a.filter.checkFeature(a.widgets.registered.image.features.align)),f?this.setState(d.data.align==e?CKEDITOR.TRISTATE_ON:e in k?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED):this.setState(CKEDITOR.TRISTATE_DISABLED),b.cancel())})}}}
function M(a){a.plugins.link&&(CKEDITOR.on("dialogDefinition",function(b){b=b.data;if("link"==b.name){b=b.definition;var f=b.onShow,e=b.onOk;b.onShow=function(){var d=l(a),b=this.getContentElement("info","linkDisplayText").getElement().getParent().getParent();d&&(d.inline?!d.wrapper.getAscendant("a"):1)?(this.setupContent(d.data.link||{}),b.hide()):(b.show(),f.apply(this,arguments))};b.onOk=function(){var b=l(a);if(b&&(b.inline?!b.wrapper.getAscendant("a"):1)){var c={};this.commitContent(c);b.setData("link",
c)}else e.apply(this,arguments)}}}),a.getCommand("unlink").on("exec",function(b){var f=l(a);f&&f.parts.link&&(f.setData("link",null),this.refresh(a,a.elementPath()),b.cancel())}),a.getCommand("unlink").on("refresh",function(b){var f=l(a);f&&(this.setState(f.data.link||f.wrapper.getAscendant("a")?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),b.cancel())}))}function l(a){return(a=a.widgets.focused)&&"image"==a.name?a:null}function F(a){var b=a.config.image3_alignClasses;a={div:{match:u(a)},p:{match:u(a)},
img:{attributes:"!src,alt,width,height",styles:"border-style,border-width,float,height,margin,margin-bottom,margin-left,margin-right,margin-top,width"},figure:{classes:"!"+a.config.image3_captionedClass},figcaption:!0};b?(a.div.classes=b[1],a.p.classes=a.div.classes,a.img.classes=b[0]+","+b[2],a.figure.classes+=","+a.img.classes):(a.div.styles="text-align",a.p.styles="text-align",a.figure.styles="float,display");return a}function G(a){a=a.config.image3_alignClasses;return{dimension:{requiredContent:"img[width,height]"},
align:{requiredContent:"img"+(a?"("+a[0]+")":"{float}")},caption:{requiredContent:"figcaption"}}}function t(a){return a.data.hasCaption?a.element:a.parts.image}var N=new CKEDITOR.template('\x3cfigure class\x3d"{captionedClass}"\x3e\x3cimg alt\x3d"" src\x3d"" /\x3e\x3cfigcaption\x3e{captionPlaceholder}\x3c/figcaption\x3e\x3c/figure\x3e'),w={left:0,center:1,right:2};CKEDITOR.plugins.add("image3",{lang:"af,ar,az,bg,bn,bs,ca,cs,cy,da,de,de-ch,el,en,en-au,en-ca,en-gb,eo,es,es-mx,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,oc,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",
requires:"widget,dialog",icons:"image",hidpi:!0,onLoad:function(){CKEDITOR.addCss(".cke_image_nocaption{line-height:0}.cke_editable.cke_image_sw, .cke_editable.cke_image_sw *{cursor:sw-resize !important}.cke_editable.cke_image_se, .cke_editable.cke_image_se *{cursor:se-resize !important}.cke_image_resizer{display:none;position:absolute;width:10px;height:10px;bottom:-5px;right:-5px;background:#000;outline:1px solid #fff;line-height:0;cursor:se-resize;}.cke_image_resizer_wrapper{position:relative;display:inline-block;line-height:0;}.cke_image_resizer.cke_image_resizer_left{right:auto;left:-5px;cursor:sw-resize;}.cke_widget_wrapper:hover .cke_image_resizer,.cke_image_resizer.cke_image_resizing{display:block}.cke_widget_wrapper\x3ea{display:inline-block}")},
init:function(a){var b=a.config,f=a.lang.image3,e=E(a);b.filebrowserImage3BrowseUrl=b.filebrowserImageBrowseUrl;b.filebrowserImage3UploadUrl=b.filebrowserImageUploadUrl;e.pathName=f.pathName;e.editables.caption.pathName=f.pathNameCaption;a.widgets.add("image",e);a.ui.addButton&&a.ui.addButton("Image",{label:a.lang.common.resize,command:"image",toolbar:"insert,10"});a.contextMenu&&(a.addMenuGroup("image",10),a.addMenuItem("image",{label:f.menu,command:"image",group:"image"}));CKEDITOR.dialog.add("image3",
this.path+"dialogs/image3.js")},afterInit:function(a){var b={left:1,right:1,center:1,block:1},f=L(a),e;for(e in b)f(e);M(a)}});CKEDITOR.plugins.image3={PERCENT:"%",PIXEL:"px",stateShifter:function(a){function b(a,b){var c={};d?c.attributes={"class":d[1]}:c.styles={"text-align":"center"};c=e.createElement(a.activeEnterMode==CKEDITOR.ENTER_P?"p":"div",c);f(c,b);b.move(c);return c}function f(b,d){if(d.getParent()){var c=a.createRange();c.moveToPosition(d,CKEDITOR.POSITION_BEFORE_START);d.remove();g.insertElementIntoRange(b,
c)}else b.replace(d)}var e=a.document,d=a.config.image3_alignClasses,c=a.config.image3_captionedClass,g=a.editable(),k=["hasCaption","align","link"],l={align:function(c,e,h){var f=c.element;c.changed.align?c.newData.hasCaption||("center"==h&&(c.deflate(),c.element=b(a,f)),c.changed.hasCaption||"center"!=e||"center"==h||(c.deflate(),e=f.findOne("a,img"),e.replace(f),c.element=e)):"center"==h&&c.changed.hasCaption&&!c.newData.hasCaption&&(c.deflate(),c.element=b(a,f));!d&&f.is("figure")&&("center"==
h?f.setStyle("display","inline-block"):f.removeStyle("display"))},hasCaption:function(b,d,h){b.changed.hasCaption&&(d=b.element.is({img:1,a:1})?b.element:b.element.findOne("a,img"),b.deflate(),h?(h=CKEDITOR.dom.element.createFromHtml(N.output({captionedClass:c,captionPlaceholder:a.lang.image3.captionPlaceholder}),e),f(h,b.element),d.replace(h.findOne("img")),b.element=h):(d.replace(b.element),b.element=d))},link:function(b,d,c){if(b.changed.link){var f=b.element.is("img")?b.element:b.element.findOne("img"),
g=b.element.is("a")?b.element:b.element.findOne("a"),k=b.element.is("a")&&!c||b.element.is("img")&&c,l;k&&b.deflate();c?(d||(l=e.createElement("a",{attributes:{href:b.newData.link.url}}),l.replace(f),f.move(l)),c=CKEDITOR.plugins.image3.getLinkAttributesGetter()(a,c),CKEDITOR.tools.isEmpty(c.set)||(l||g).setAttributes(c.set),c.removed.length&&(l||g).removeAttributes(c.removed)):(c=g.findOne("img"),c.replace(g),l=c);k&&(b.element=l)}}};return function(a){var b,c;a.changed={};for(c=0;c<k.length;c++)b=
k[c],a.changed[b]=a.oldData?a.oldData[b]!==a.newData[b]:!1;for(c=0;c<k.length;c++)b=k[c],l[b](a,a.oldData?a.oldData[b]:null,a.newData[b]);a.inflate()}},checkHasNaturalRatio:function(a){var b=a.$;a=this.getNatural(a);return Math.round(b.clientWidth/a.width*a.height)==b.clientHeight||Math.round(b.clientHeight/a.height*a.width)==b.clientWidth},getNatural:function(a){if(a.$.naturalWidth)a={width:a.$.naturalWidth,height:a.$.naturalHeight};else{var b=new Image;b.src=a.getAttribute("src");a={width:b.width,
height:b.height}}return a},convertDimensionsTo:function(a,b,f,e){var d=a.wrapper.getParent().getClientRect(),c=d.width,d=d.height;void 0==typeof e&&(e=this.getNatural(a.parts.image));a={width:0,height:0};f==this.PIXEL?(a.width=Math.round(b.width/100*c),a.height=Math.round((e.height||1)/(e.width||1)*a.width)):f==this.PERCENT&&(0==c&&(c=1),0==d&&(d=1),a.height=Math.round(b.height/d*100),a.width=Math.round(b.width/c*100));return a},getLinkAttributesGetter:function(){return CKEDITOR.plugins.link.getLinkAttributes},
getLinkAttributesParser:function(){return CKEDITOR.plugins.link.parseLinkAttributes}}})();CKEDITOR.config.image3_captionedClass="image";