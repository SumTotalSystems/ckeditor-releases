/*
 Copyright (c) 2003-2017, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
 This plugin is a direct copy of Image2 with added logic to handle sizing images by percentages.
*/
(function(){function C(a){function b(){this.deflated||(a.widgets.focused==this.widget&&(this.focused=!0),a.widgets.destroy(this.widget),this.deflated=!0)}function d(){var e=a.editable(),c=a.document;if(this.deflated)this.widget=a.widgets.initOn(this.element,"image",this.widget.data),this.widget.inline&&!(new CKEDITOR.dom.elementPath(this.widget.wrapper,e)).block&&(e=c.createElement(a.activeEnterMode==CKEDITOR.ENTER_P?"p":"div"),e.replace(this.widget.wrapper),this.widget.wrapper.move(e)),this.focused&&
(this.widget.focus(),delete this.focused),delete this.deflated;else{var b=this.widget,e=g,c=b.wrapper,d=b.data.align,b=b.data.hasCaption;if(e){for(var w=3;w--;)c.removeClass(e[w]);"center"==d?b&&c.addClass(e[1]):"none"!=d&&c.addClass(e[p[d]])}else"center"==d?(b?c.setStyle("text-align","center"):c.removeStyle("text-align"),c.removeStyle("float")):("none"==d?c.removeStyle("float"):c.setStyle("float",d),c.removeStyle("text-align"))}}var g=a.config.image3_alignClasses,f=a.config.image3_captionedClass;
return{allowedContent:D(a),requiredContent:"img[src,alt]",features:E(a),styleableElements:"img figure",contentTransformations:[],editables:{caption:{selector:"figcaption",allowedContent:"br em strong sub sup u s; a[!href,target]"}},parts:{image:"img",caption:"figcaption"},dialog:"image3",template:'\x3cimg alt\x3d"" src\x3d"" /\x3e',data:function(){var e=this.features;this.data.hasCaption&&!a.filter.checkFeature(e.caption)&&(this.data.hasCaption=!1);"none"==this.data.align||a.filter.checkFeature(e.align)||
(this.data.align="none");this.shiftState({widget:this,element:this.element,oldData:this.oldData,newData:this.data,deflate:b,inflate:d});this.data.link?this.parts.link||(this.parts.link=this.parts.image.getParent()):this.parts.link&&delete this.parts.link;this.parts.image.setAttributes({src:this.data.src,"data-cke-saved-src":this.data.src,alt:this.data.alt});if(this.oldData&&!this.oldData.hasCaption&&this.data.hasCaption)for(var c in this.data.classes)this.parts.image.removeClass(c);if(a.filter.checkFeature(e.dimension)){e=
this.data;c={width:e.width,height:e.height};var g=this.parts.image,f;for(f in c)c[f]?g.setAttribute(f,c[f]+e.sizeImageBy):g.removeAttribute(f)}this.oldData=CKEDITOR.tools.extend({},this.data)},init:function(){var b=CKEDITOR.plugins.image3,c=this.parts.image,d={hasCaption:!!this.parts.caption,src:c.getAttribute("src"),alt:c.getAttribute("alt")||"",width:c.getAttribute("width")||"",height:c.getAttribute("height")||"",lock:this.ready?b.checkHasNaturalRatio(c):!0},f=function(a,d){return a.substring(0,
a.length-d.length)};-1==d.width.indexOf("%")&&-1==d.height.indexOf("%")?d.sizeImageBy="px":d.sizeImageBy="%";d.width=f(d.width,d.sizeImageBy);d.height=f(d.height,d.sizeImageBy);(f=c.getAscendant("a"))&&this.wrapper.contains(f)&&(this.parts.link=f);d.align||(c=d.hasCaption?this.element:c,g?(c.hasClass(g[0])?d.align="left":c.hasClass(g[2])&&(d.align="right"),d.align?c.removeClass(g[p[d.align]]):d.align="none"):(d.align=c.getStyle("float")||"none",c.removeStyle("float")));a.plugins.link&&this.parts.link&&
(d.link=b.getLinkAttributesParser()(a,this.parts.link),(c=d.link.advanced)&&c.advCSSClasses&&(c.advCSSClasses=CKEDITOR.tools.trim(c.advCSSClasses.replace(/cke_\S+/,""))));this.wrapper[(d.hasCaption?"remove":"add")+"Class"]("cke_image_nocaption");this.setData(d);a.filter.checkFeature(this.features.dimension)&&!0!==a.config.image3_disableResizer&&1!=a.readOnly&&F(this);this.shiftState=b.stateShifter(this.editor);this.on("contextMenu",function(a){a.data.image=CKEDITOR.TRISTATE_OFF;if(this.parts.link||
this.wrapper.getAscendant("a"))a.data.link=a.data.unlink=CKEDITOR.TRISTATE_OFF});this.on("dialog",function(a){a.data.widget=this},this)},addClass:function(a){l(this).addClass(a)},hasClass:function(a){return l(this).hasClass(a)},removeClass:function(a){l(this).removeClass(a)},getClasses:function(){var a=new RegExp("^("+[].concat(f,g).join("|")+")$");return function(){var d=this.repository.parseElementClasses(l(this).getAttribute("class")),b;for(b in d)a.test(b)&&delete d[b];return d}}(),upcast:G(a),
downcast:H(a),getLabel:function(){return this.editor.lang.widget.label.replace(/%1/,(this.data.alt||"")+" "+this.pathName)}}}function G(a){var b=m(a),d=a.config.image3_captionedClass;return function(a,f){var e=a.name,c;if(!a.attributes["data-cke-realelement"]&&(b(a)?("div"==e&&(e=a.getFirst("figure"))&&(a.replaceWith(e),a=e),f.align="center",c=a.getFirst("img")||a.getFirst("a").getFirst("img")):"figure"==e&&a.hasClass(d)?c=a.getFirst("img")||a.getFirst("a").getFirst("img"):q(a)&&(c="a"==a.name?a.children[0]:
a),c))return a}}function H(a){var b=a.config.image3_alignClasses;return function(a){var g="a"==a.name?a.getFirst():a,f=g.attributes,e=this.data.align;if(!this.inline){var c=a.getFirst("span");c&&c.replaceWith(c.getFirst({img:1,a:1}))}e&&"none"!=e&&(c=CKEDITOR.tools.parseCssText(f.style||""),"center"==e&&"figure"==a.name?a=a.wrapWith(new CKEDITOR.htmlParser.element("div",b?{"class":b[1]}:{style:"text-align:center"})):e in{left:1,right:1}&&(b?g.addClass(b[p[e]]):c["float"]=e),b||CKEDITOR.tools.isEmpty(c)||
(f.style=CKEDITOR.tools.writeCssText(c)));return a}}function m(a){var b=a.config.image3_captionedClass,d=a.config.image3_alignClasses,g={figure:1,a:1,img:1};return function(f){if(!(f.name in{div:1,p:1}))return!1;var e=f.children;if(1!==e.length)return!1;e=e[0];if(!(e.name in g))return!1;if("p"==f.name){if(!q(e))return!1}else if("figure"==e.name){if(!e.hasClass(b))return!1}else if(a.enterMode==CKEDITOR.ENTER_P||!q(e))return!1;return(d?f.hasClass(d[1]):"center"==CKEDITOR.tools.parseCssText(f.attributes.style||
"",!0)["text-align"])?!0:!1}}function q(a){return"img"==a.name?!0:"a"==a.name?1==a.children.length&&a.getFirst("img"):!1}function F(a){if("%"!=a.data.sizeImageBy){var b=a.editor,d=b.editable(),g=b.document,f=a.resizer=g.createElement("span");f.addClass("cke_image_resizer");f.setAttribute("title",b.lang.image3.resizer);f.append(new CKEDITOR.dom.text("​",g));if(a.inline)a.wrapper.append(f);else{var e=a.parts.link||a.parts.image,c=e.getParent(),k=g.createElement("span");k.addClass("cke_image_resizer_wrapper");
k.append(e);k.append(f);a.element.append(k,!0);c.is("span")&&c.remove()}f.on("mousedown",function(c){function w(a,b,d){var c=CKEDITOR.document,e=[];g.equals(c)||e.push(c.on(a,b));e.push(g.on(a,b));if(d)for(a=e.length;a--;)d.push(e.pop())}function e(){r=l+k*x;t=Math.round(r/u)}function v(){t=p-n;r=Math.round(t*u)}var A=a.parts.image,k="right"==a.data.align?-1:1,h=c.data.$.screenX,I=c.data.$.screenY,l=A.$.clientWidth,p=A.$.clientHeight,u=l/p,m=[],q="cke_image_s"+(~k?"e":"w"),B,r,t,z,x,n,y;b.fire("saveSnapshot");
w("mousemove",function(a){B=a.data.$;x=B.screenX-h;n=I-B.screenY;y=Math.abs(x/n);1==k?0>=x?0>=n?e():y>=u?e():v():0>=n?y>=u?v():e():v():0>=x?0>=n?y>=u?v():e():v():0>=n?e():y>=u?e():v();15<=r&&15<=t?(A.setAttributes({width:r,height:t}),z=!0):z=!1},m);w("mouseup",function(){for(var c;c=m.pop();)c.removeListener();d.removeClass(q);f.removeClass("cke_image_resizing");z&&(a.setData({width:r,height:t}),b.fire("saveSnapshot"));z=!1},m);d.addClass(q);f.addClass("cke_image_resizing")});a.on("data",function(){f["right"==
a.data.align?"addClass":"removeClass"]("cke_image_resizer_left")})}}function J(a){var b=[],d;return function(g){var f=a.getCommand("justify"+g);if(f){b.push(function(){f.refresh(a,a.elementPath())});if(g in{right:1,left:1,center:1})f.on("exec",function(d){var c=h(a);if(c){c.setData("align",g);for(c=b.length;c--;)b[c]();d.cancel()}});f.on("refresh",function(b){var c=h(a),f={right:1,left:1,center:1};c&&(void 0===d&&(d=a.filter.checkFeature(a.widgets.registered.image.features.align)),d?this.setState(c.data.align==
g?CKEDITOR.TRISTATE_ON:g in f?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED):this.setState(CKEDITOR.TRISTATE_DISABLED),b.cancel())})}}}function K(a){a.plugins.link&&(CKEDITOR.on("dialogDefinition",function(b){b=b.data;if("link"==b.name){b=b.definition;var d=b.onShow,g=b.onOk;b.onShow=function(){var b=h(a),e=this.getContentElement("info","linkDisplayText").getElement().getParent().getParent();b&&(b.inline?!b.wrapper.getAscendant("a"):1)?(this.setupContent(b.data.link||{}),e.hide()):(e.show(),d.apply(this,
arguments))};b.onOk=function(){var b=h(a);if(b&&(b.inline?!b.wrapper.getAscendant("a"):1)){var d={};this.commitContent(d);b.setData("link",d)}else g.apply(this,arguments)}}}),a.getCommand("unlink").on("exec",function(b){var d=h(a);d&&d.parts.link&&(d.setData("link",null),this.refresh(a,a.elementPath()),b.cancel())}),a.getCommand("unlink").on("refresh",function(b){var d=h(a);d&&(this.setState(d.data.link||d.wrapper.getAscendant("a")?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),b.cancel())}))}
function h(a){return(a=a.widgets.focused)&&"image"==a.name?a:null}function D(a){var b=a.config.image3_alignClasses;a={div:{match:m(a)},p:{match:m(a)},img:{attributes:"!src,alt,width,height",styles:"border-style,border-width,float,height,margin,margin-bottom,margin-left,margin-right,margin-top,width"},figure:{classes:"!"+a.config.image3_captionedClass},figcaption:!0};b?(a.div.classes=b[1],a.p.classes=a.div.classes,a.img.classes=b[0]+","+b[2],a.figure.classes+=","+a.img.classes):(a.div.styles="text-align",
a.p.styles="text-align",a.figure.styles="float,display");return a}function E(a){a=a.config.image3_alignClasses;return{dimension:{requiredContent:"img[width,height]"},align:{requiredContent:"img"+(a?"("+a[0]+")":"{float}")},caption:{requiredContent:"figcaption"}}}function l(a){return a.data.hasCaption?a.element:a.parts.image}var L=new CKEDITOR.template('\x3cfigure class\x3d"{captionedClass}"\x3e\x3cimg alt\x3d"" src\x3d"" /\x3e\x3cfigcaption\x3e{captionPlaceholder}\x3c/figcaption\x3e\x3c/figure\x3e'),
p={left:0,center:1,right:2};CKEDITOR.plugins.add("image3",{lang:"af,ar,az,bg,bn,bs,ca,cs,cy,da,de,de-ch,el,en,en-au,en-ca,en-gb,eo,es,es-mx,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,oc,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,tt,ug,uk,vi,zh,zh-cn",requires:"widget,dialog",icons:"image",hidpi:!0,onLoad:function(){CKEDITOR.addCss(".cke_image_nocaption{line-height:0}.cke_editable.cke_image_sw, .cke_editable.cke_image_sw *{cursor:sw-resize !important}.cke_editable.cke_image_se, .cke_editable.cke_image_se *{cursor:se-resize !important}.cke_image_resizer{display:none;position:absolute;width:10px;height:10px;bottom:-5px;right:-5px;background:#000;outline:1px solid #fff;line-height:0;cursor:se-resize;}.cke_image_resizer_wrapper{position:relative;display:inline-block;line-height:0;}.cke_image_resizer.cke_image_resizer_left{right:auto;left:-5px;cursor:sw-resize;}.cke_widget_wrapper:hover .cke_image_resizer,.cke_image_resizer.cke_image_resizing{display:block}.cke_widget_wrapper\x3ea{display:inline-block}")},
init:function(a){var b=a.config,d=a.lang.image3,g=C(a);b.filebrowserImage3BrowseUrl=b.filebrowserImageBrowseUrl;b.filebrowserImage3UploadUrl=b.filebrowserImageUploadUrl;g.pathName=d.pathName;g.editables.caption.pathName=d.pathNameCaption;a.widgets.add("image",g);a.ui.addButton&&a.ui.addButton("Image",{label:a.lang.common.resize,command:"image",toolbar:"insert,10"});a.contextMenu&&(a.addMenuGroup("image",10),a.addMenuItem("image",{label:d.menu,command:"image",group:"image"}));CKEDITOR.dialog.add("image3",
this.path+"dialogs/image3.js")},afterInit:function(a){var b={left:1,right:1,center:1,block:1},d=J(a),g;for(g in b)d(g);K(a)}});CKEDITOR.plugins.image3={stateShifter:function(a){function b(a,b){var c={};f?c.attributes={"class":f[1]}:c.styles={"text-align":"center"};c=g.createElement(a.activeEnterMode==CKEDITOR.ENTER_P?"p":"div",c);d(c,b);b.move(c);return c}function d(b,d){if(d.getParent()){var e=a.createRange();e.moveToPosition(d,CKEDITOR.POSITION_BEFORE_START);d.remove();c.insertElementIntoRange(b,
e)}else b.replace(d)}var g=a.document,f=a.config.image3_alignClasses,e=a.config.image3_captionedClass,c=a.editable(),k=["hasCaption","align","link"],h={align:function(d,c,e){var g=d.element;d.changed.align?d.newData.hasCaption||("center"==e&&(d.deflate(),d.element=b(a,g)),d.changed.hasCaption||"center"!=c||"center"==e||(d.deflate(),c=g.findOne("a,img"),c.replace(g),d.element=c)):"center"==e&&d.changed.hasCaption&&!d.newData.hasCaption&&(d.deflate(),d.element=b(a,g));!f&&g.is("figure")&&("center"==
e?g.setStyle("display","inline-block"):g.removeStyle("display"))},hasCaption:function(b,c,f){b.changed.hasCaption&&(c=b.element.is({img:1,a:1})?b.element:b.element.findOne("a,img"),b.deflate(),f?(f=CKEDITOR.dom.element.createFromHtml(L.output({captionedClass:e,captionPlaceholder:a.lang.image3.captionPlaceholder}),g),d(f,b.element),c.replace(f.findOne("img")),b.element=f):(c.replace(b.element),b.element=c))},link:function(b,d,c){if(b.changed.link){var e=b.element.is("img")?b.element:b.element.findOne("img"),
f=b.element.is("a")?b.element:b.element.findOne("a"),k=b.element.is("a")&&!c||b.element.is("img")&&c,h;k&&b.deflate();c?(d||(h=g.createElement("a",{attributes:{href:b.newData.link.url}}),h.replace(e),e.move(h)),c=CKEDITOR.plugins.image3.getLinkAttributesGetter()(a,c),CKEDITOR.tools.isEmpty(c.set)||(h||f).setAttributes(c.set),c.removed.length&&(h||f).removeAttributes(c.removed)):(c=f.findOne("img"),c.replace(f),h=c);k&&(b.element=h)}}};return function(a){var b,c;a.changed={};for(c=0;c<k.length;c++)b=
k[c],a.changed[b]=a.oldData?a.oldData[b]!==a.newData[b]:!1;for(c=0;c<k.length;c++)b=k[c],h[b](a,a.oldData?a.oldData[b]:null,a.newData[b]);a.inflate()}},checkHasNaturalRatio:function(a){var b=a.$;a=this.getNatural(a);return Math.round(b.clientWidth/a.width*a.height)==b.clientHeight||Math.round(b.clientHeight/a.height*a.width)==b.clientWidth},getNatural:function(a){if(a.$.naturalWidth)a={width:a.$.naturalWidth,height:a.$.naturalHeight};else{var b=new Image;b.src=a.getAttribute("src");a={width:b.width,
height:b.height}}return a},getLinkAttributesGetter:function(){return CKEDITOR.plugins.link.getLinkAttributes},getLinkAttributesParser:function(){return CKEDITOR.plugins.link.parseLinkAttributes}}})();CKEDITOR.config.image3_captionedClass="image";